<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Knockoff Tests</title>
    </head>
    <body>
        <script src="js/KO-1.0.32.js"></script>
        <script>
            'use strict';

            function assertEqual(val1, val2) {
                if (val1 !== val2) {
                    throw 'Expected ' + val2 + ' but was ' + val1;
                }
            }

            function setElementValue(el, newValue) {
                switch (el.type) {
                    case 'text':
                    case 'textarea':
                    case 'select-one':
                        el.value = newValue === undefined ? '' : newValue;
                        break;
                    case 'checkbox':
                        el.checked = newValue === undefined ? false : newValue;
                        break;
                    default:
                        el.innerHTML = newValue === undefined ? '' : newValue;
                }

                el.dispatchEvent(new Event('change', {
                    bubbles: true
                }));
            }

            function testBind() {
                var testContainer = document.createElement('div');
                testContainer.style.display = 'none';
                document.body.appendChild(testContainer);

                var nameSpan = document.createElement('span');
                nameSpan.dataset.mapping = 'name';
                testContainer.appendChild(nameSpan);

                var nameInput = document.createElement('input');
                nameInput.dataset.mapping = 'name';
                nameInput.type = 'text';
                testContainer.appendChild(nameInput);

                var levelInput = document.createElement('input');
                levelInput.dataset.mapping = 'level';
                levelInput.type = 'text';
                testContainer.appendChild(levelInput);

                var undeadInput = document.createElement('input');
                undeadInput.dataset.mapping = 'undead';
                undeadInput.type = 'checkbox';
                testContainer.appendChild(undeadInput);

                var raceSelect = document.createElement('select');
                raceSelect.dataset.mapping = 'race';
                raceSelect.innerHTML = '<option value="">Select one...</option><option value="Human">Human</option><option value="Klingon">Klingon</option><option value="Vulcan">Vulcan</option>';
                testContainer.appendChild(raceSelect);

                var descriptionTextarea = document.createElement('textarea');
                descriptionTextarea.dataset.mapping = 'description';
                testContainer.appendChild(descriptionTextarea);

                var skillsProgrammingDayInput = document.createElement('input');
                skillsProgrammingDayInput.dataset.mapping = 'skills.programming.day';
                skillsProgrammingDayInput.type = 'text';
                testContainer.appendChild(skillsProgrammingDayInput);

                var skillsProgrammingNightInput = document.createElement('input');
                skillsProgrammingNightInput.dataset.mapping = 'skills.programming.night';
                skillsProgrammingNightInput.type = 'text';
                testContainer.appendChild(skillsProgrammingNightInput);

                var skillsUnderwaterBasketWeavingDayInput = document.createElement('input');
                skillsUnderwaterBasketWeavingDayInput.dataset.mapping = 'skills.underwaterBasketWeaving.day';
                skillsUnderwaterBasketWeavingDayInput.type = 'text';
                testContainer.appendChild(skillsUnderwaterBasketWeavingDayInput);

                var skillsUnderwaterBasketWeavingNightInput = document.createElement('input');
                skillsUnderwaterBasketWeavingNightInput.dataset.mapping = 'skills.underwaterBasketWeaving.night';
                skillsUnderwaterBasketWeavingNightInput.type = 'text';
                testContainer.appendChild(skillsUnderwaterBasketWeavingNightInput);

                var powers0NameInput = document.createElement('input');
                powers0NameInput.dataset.mapping = 'powers.0.name';
                powers0NameInput.type = 'text';
                testContainer.appendChild(powers0NameInput);

                var powers0DescriptionInput = document.createElement('input');
                powers0DescriptionInput.dataset.mapping = 'powers.0.description';
                powers0DescriptionInput.type = 'text';
                testContainer.appendChild(powers0DescriptionInput);

                var powers1NameInput = document.createElement('input');
                powers1NameInput.dataset.mapping = 'powers.1.name';
                powers1NameInput.type = 'text';
                testContainer.appendChild(powers1NameInput);

                var powers1DescriptionInput = document.createElement('input');
                powers1DescriptionInput.dataset.mapping = 'powers.1.description';
                powers1DescriptionInput.type = 'text';
                testContainer.appendChild(powers1DescriptionInput);

                var model = {
                    name: 'Dave',
                    level: 10,
                    undead: true,
                    race: 'Human',
                    description: 'As a young boy, Dave created lego masterpieces and wrestled alligators. This is why he only has one arm...',
                    skills: {
                        programming: { day: 10, night: 20 },
                        underwaterBasketWeaving: { day: 1, night: 2 }
                    },
                    powers: [
                        { name: 'Flurry of Keystrokes', description: 'You can type up to 80 word per minute.' },
                        { name: 'Telekenesis', description: 'You can move a pebble-sized object with your brain once per day.' }
                    ]
                };

                KO.bind(model);

                assertEqual(nameSpan.innerHTML, model.name);
                assertEqual(nameInput.value, model.name);
                assertEqual(levelInput.value, model.level.toString());
                assertEqual(undeadInput.checked, model.undead);
                assertEqual(raceSelect.value, model.race);
                assertEqual(descriptionTextarea.value, model.description);
                assertEqual(skillsProgrammingDayInput.value, model.skills.programming.day.toString());
                assertEqual(skillsProgrammingNightInput.value, model.skills.programming.night.toString());
                assertEqual(skillsUnderwaterBasketWeavingDayInput.value, model.skills.underwaterBasketWeaving.day.toString());
                assertEqual(skillsUnderwaterBasketWeavingNightInput.value, model.skills.underwaterBasketWeaving.night.toString());
                assertEqual(powers0NameInput.value, model.powers[0].name);
                assertEqual(powers0DescriptionInput.value, model.powers[0].description);
                assertEqual(powers1NameInput.value, model.powers[1].name);
                assertEqual(powers1DescriptionInput.value, model.powers[1].description);

                testContainer.remove();
                KO.unbind(model);
            }

            function testHtml() {
                var model = {
                    name: 'Dave'
                };

                KO.bind(model);

                var testContainer = document.createElement('div');
                testContainer.style.display = 'none';
                document.body.appendChild(testContainer);

                var nameSpan = document.createElement('span');
                nameSpan.dataset.mapping = 'name';
                testContainer.appendChild(nameSpan);

                setElementValue(nameSpan, 'Ruth');
                assertEqual(model.name, 'Ruth');

                model.name = 'Sarah';
                assertEqual(nameSpan.innerHTML, 'Sarah');

                testContainer.remove();
                KO.unbind(model);
            }

            function testTextInput() {
                var model = {
                    name: 'Dave'
                };

                KO.bind(model);

                var testContainer = document.createElement('div');
                testContainer.style.display = 'none';
                document.body.appendChild(testContainer);

                var nameInput = document.createElement('input');
                nameInput.dataset.mapping = 'name';
                nameInput.type = 'text';
                testContainer.appendChild(nameInput);

                setElementValue(nameInput, 'Steve');
                assertEqual(model.name, 'Steve');

                model.name = 'Bob';
                assertEqual(nameInput.value, 'Bob');

                testContainer.remove();
                KO.unbind(model);
            }

            function testNumericInput() {
                var model = {
                    level: 10
                };

                KO.bind(model);

                var testContainer = document.createElement('div');
                testContainer.style.display = 'none';
                document.body.appendChild(testContainer);

                var levelInput = document.createElement('input');
                levelInput.dataset.mapping = 'level';
                levelInput.type = 'text';
                testContainer.appendChild(levelInput);

                setElementValue(levelInput, '12');
                assertEqual(model.level, 12);

                model.level = 14;
                assertEqual(levelInput.value, '14');

                testContainer.remove();
                KO.unbind(model);
            }

            function testCheckbox() {
                var model = {
                    undead: true
                };

                KO.bind(model);

                var testContainer = document.createElement('div');
                testContainer.style.display = 'none';
                document.body.appendChild(testContainer);

                var undeadInput = document.createElement('input');
                undeadInput.dataset.mapping = 'undead';
                undeadInput.type = 'checkbox';
                testContainer.appendChild(undeadInput);

                setElementValue(undeadInput, false);
                assertEqual(model.undead, false);

                model.undead = true;
                assertEqual(undeadInput.checked, true);

                testContainer.remove();
                KO.unbind(model);
            }

            function testSelect() {
                var model = {
                    race: 'Human'
                };

                KO.bind(model);

                var testContainer = document.createElement('div');
                testContainer.style.display = 'none';
                document.body.appendChild(testContainer);

                var raceSelect = document.createElement('select');
                raceSelect.dataset.mapping = 'race';
                raceSelect.innerHTML = '<option value="">Select one...</option><option value="Human">Human</option><option value="Klingon">Klingon</option><option value="Vulcan">Vulcan</option>';
                testContainer.appendChild(raceSelect);

                setElementValue(raceSelect, 'Klingon');
                assertEqual(model.race, 'Klingon');

                model.race = 'Vulcan';
                assertEqual(raceSelect.value, 'Vulcan');

                testContainer.remove();
                KO.unbind(model);
            }

            function testTextarea() {
                var model = {
                    description: 'As a young boy, Dave created lego masterpieces and wrestled alligators. This is why he only has one arm...'
                };

                KO.bind(model);

                var testContainer = document.createElement('div');
                testContainer.style.display = 'none';
                document.body.appendChild(testContainer);

                var descriptionTextarea = document.createElement('textarea');
                descriptionTextarea.dataset.mapping = 'description';
                testContainer.appendChild(descriptionTextarea);

                setElementValue(descriptionTextarea, 'I am a banana!');
                assertEqual(model.description, 'I am a banana!');

                model.description = 'Blah blah blah...';
                assertEqual(descriptionTextarea.value, 'Blah blah blah...');

                testContainer.remove();
                KO.unbind(model);
            }

            function testNested() {
                var model = {
                    skills: {
                        programming: { day: 10, night: 20 },
                        underwaterBasketWeaving: { day: 1, night: 2 }
                    }
                };

                KO.bind(model);

                var testContainer = document.createElement('div');
                testContainer.style.display = 'none';
                document.body.appendChild(testContainer);

                var skillsProgrammingDayInput = document.createElement('input');
                skillsProgrammingDayInput.dataset.mapping = 'skills.programming.day';
                skillsProgrammingDayInput.type = 'text';
                testContainer.appendChild(skillsProgrammingDayInput);

                setElementValue(skillsProgrammingDayInput, '12');
                assertEqual(model.skills.programming.day, 12);

                model.skills.programming.day = 14;
                assertEqual(skillsProgrammingDayInput.value, '14');

                testContainer.remove();
                KO.unbind(model);
            }

            function testArray() {
                var model = {
                    powers: [
                        { name: 'Flurry of Keystrokes', description: 'You can type up to 80 word per minute.' },
                        { name: 'Telekenesis', description: 'You can move a pebble-sized object with your brain once per day.' }
                    ]
                };

                KO.bind(model);

                var testContainer = document.createElement('div');
                testContainer.style.display = 'none';
                document.body.appendChild(testContainer);

                var powers0NameInput = document.createElement('input');
                powers0NameInput.dataset.mapping = 'powers.0.name';
                powers0NameInput.type = 'text';
                testContainer.appendChild(powers0NameInput);

                setElementValue(powers0NameInput, 'Mental Domination');
                assertEqual(model.powers[0].name, 'Mental Domination');

                model.powers[0].name = 'Ninja Flipping';
                assertEqual(powers0NameInput.value, 'Ninja Flipping');

                testContainer.remove();
                KO.unbind(model);
            }

            function testListen() {
                var model = {
                    name: 'Dave'
                };

                KO.bind(model);

                var callback = false;

                KO.listen('name', function (event) {
                    assertEqual(event.detail.mapping, 'name');
                    assertEqual(event.detail.newValue, 'Bob');
                    assertEqual(event.detail.oldValue, 'Dave');

                    callback = true;
                });

                model.name = 'Bob';

                // wait a sec to make sure callback was fired
                setTimeout(function () {
                    assertEqual(callback, true);
                }, 1000);

                KO.unbind(model);
            }

            function testListenArray() {
                var model = {
                    name: 'Dave',
                    level: 10
                };

                KO.bind(model);

                var firstCallback = false,
                    secondCallback = false;

                KO.listen(['name', 'level'], function (event) {
                    if (event.detail.mapping === 'name') {
                        assertEqual(event.detail.newValue, 'Bob');
                        assertEqual(event.detail.oldValue, 'Dave');

                        firstCallback = true;
                    } else if (event.detail.mapping === 'level') {
                        assertEqual(event.detail.newValue, 12);
                        assertEqual(event.detail.oldValue, 10);

                        secondCallback = true;
                    } else {
                        throw 'Callback called with unexpected mapping ' + event.detail.mapping;
                    }
                });

                model.name = 'Bob';
                model.level = 12;

                // wait a sec to make sure callback was fired
                setTimeout(function () {
                    assertEqual(firstCallback, true);
                    assertEqual(secondCallback, true);
                }, 1000);

                KO.unbind(model);
            }

            function testListenRegExp() {
                var model = {
                    skills: {
                        programming: { day: 10, night: 20 },
                        underwaterBasketWeaving: { day: 1, night: 2 }
                    }
                };

                KO.bind(model);

                var firstCallback = false,
                    secondCallback = false;

                KO.listen(/skills\.(.*)\.day/, function (event, match) {
                    var skill = match[1];

                    if (skill === 'programming') {
                        assertEqual(event.detail.newValue, 12);
                        assertEqual(event.detail.oldValue, 10);

                        firstCallback = true;
                    } else if (skill === 'underwaterBasketWeaving') {
                        assertEqual(event.detail.newValue, 2);
                        assertEqual(event.detail.oldValue, 1);

                        secondCallback = true;
                    } else {
                        throw 'Callback called with unexpected mapping ' + event.detail.mapping;
                    }
                });

                model.skills.programming.day = 12;
                model.skills.underwaterBasketWeaving.day = 2;

                // wait a sec to make sure callback was fired
                setTimeout(function () {
                    assertEqual(firstCallback, true);
                    assertEqual(secondCallback, true);
                }, 1000);

                KO.unbind(model);
            }

            function testValidate() {
                var model = {
                    name: 'Dave'
                };

                KO.bind(model);

                var callback = false;

                KO.validate('name', function (event) {
                    assertEqual(event.detail.mapping, 'name');
                    assertEqual(event.detail.newValue, 'Bob');
                    assertEqual(event.detail.oldValue, 'Dave');

                    callback = true;

                    return false;
                });

                model.name = 'Bob';

                assertEqual(model.name, 'Dave');

                // wait a sec to make sure callback was fired
                setTimeout(function () {
                    assertEqual(callback, true);
                }, 1000);

                KO.unbind(model);
            }

            function testValidateArray() {
                var model = {
                    name: 'Dave',
                    level: 10
                };

                KO.bind(model);

                var firstCallback = false,
                    secondCallback = false;

                KO.validate(['name', 'level'], function (event) {
                    if (event.detail.mapping === 'name') {
                        assertEqual(event.detail.newValue, 'Bob');
                        assertEqual(event.detail.oldValue, 'Dave');

                        firstCallback = true;
                    } else if (event.detail.mapping === 'level') {
                        assertEqual(event.detail.newValue, 12);
                        assertEqual(event.detail.oldValue, 10);

                        secondCallback = true;
                    } else {
                        throw 'Callback called with unexpected mapping ' + event.detail.mapping;
                    }

                    return false;
                });

                model.name = 'Bob';
                model.level = 12;

                assertEqual(model.name, 'Dave');
                assertEqual(model.level, 10);

                // wait a sec to make sure callback was fired
                setTimeout(function () {
                    assertEqual(firstCallback, true);
                    assertEqual(secondCallback, true);
                }, 1000);

                KO.unbind(model);
            }

            function testValidateRegExp() {
                var model = {
                    skills: {
                        programming: { day: 10, night: 20 },
                        underwaterBasketWeaving: { day: 1, night: 2 }
                    }
                };

                KO.bind(model);

                var firstCallback = false,
                    secondCallback = false;

                KO.validate(/skills\.(.*)\.day/, function (event, match) {
                    var skill = match[1];

                    if (skill === 'programming') {
                        assertEqual(event.detail.newValue, 12);
                        assertEqual(event.detail.oldValue, 10);

                        firstCallback = true;
                    } else if (skill === 'underwaterBasketWeaving') {
                        assertEqual(event.detail.newValue, 2);
                        assertEqual(event.detail.oldValue, 1);

                        secondCallback = true;
                    } else {
                        throw 'Callback called with unexpected mapping ' + event.detail.mapping;
                    }

                    return false;
                });

                model.skills.programming.day = 12;
                model.skills.underwaterBasketWeaving.day = 2;

                assertEqual(model.skills.programming.day, 10);
                assertEqual(model.skills.underwaterBasketWeaving.day, 1);

                // wait a sec to make sure callback was fired
                setTimeout(function () {
                    assertEqual(firstCallback, true);
                    assertEqual(secondCallback, true);
                }, 1000);

                KO.unbind(model);
            }

            function testAll() {
                testBind();
                testHtml();
                testTextInput();
                testNumericInput();
                testCheckbox();
                testSelect();
                testTextarea();
                testNested();
                testArray();
                testListen();
                testListenArray();
                testListenRegExp();
                testValidate();
                testValidateArray();
                testValidateRegExp();

                // BUG: doesn't work for async tests (listen, validate)
                alert('All tests passed!');
            }

            testAll();
        </script>
    </body>
</html>

